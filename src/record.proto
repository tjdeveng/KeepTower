// SPDX-License-Identifier: GPL-3.0-or-later
// SPDX-FileCopyrightText: 2025 tjdeveng

syntax = "proto3";

package keeptower;

// =============================================================================
// CORE CREDENTIAL TYPES
// =============================================================================

// TOTP (Time-based One-Time Password) configuration for 2FA
message TOTPConfig {
  // TOTP secret key (base32 encoded)
  string secret = 1;

  // Number of digits in the TOTP code (usually 6 or 8)
  int32 digits = 2;

  // Time step in seconds (usually 30)
  int32 period = 3;

  // Hash algorithm (SHA1, SHA256, SHA512)
  string algorithm = 4;

  // Issuer name (e.g., "Google", "GitHub")
  string issuer = 5;

  // Reserved for future TOTP enhancements
  reserved 6 to 10;
}

// Custom field for storing additional key-value data
message CustomField {
  // Field name/label
  string name = 1;

  // Field value
  string value = 2;

  // Whether this field should be treated as sensitive (masked in UI)
  bool is_sensitive = 3;

  // Field type hint (text, url, email, multiline, etc.)
  string field_type = 4;

  // Reserved for future custom field features
  reserved 5 to 10;
}

// Group membership - represents an account's membership in a specific group
message GroupMembership {
  // UUID of the group this account belongs to
  string group_id = 1;

  // Display order within this specific group
  // 0 = first, higher values = later in the list
  int32 display_order = 2;

  // Reserved for future membership metadata (e.g., added_at, role, etc.)
  reserved 3 to 10;
}

// Account group definition
message AccountGroup {
  // Unique identifier for the group (UUID v4 recommended)
  string group_id = 1;

  // Display name for the group (e.g., "Work", "Personal", "Banking")
  string group_name = 2;

  // Display order for groups in the UI
  // 0 = first group, higher values = later
  int32 display_order = 3;

  // Whether the group is expanded or collapsed in the UI
  bool is_expanded = 4;

  // Whether this is a system-managed group (e.g., "Favorites")
  // System groups cannot be deleted or renamed by users
  bool is_system_group = 5;

  // Optional description for the group
  string description = 6;

  // Optional color code for visual organization (hex format: "#RRGGBB")
  string color = 7;

  // Optional icon identifier
  string icon = 8;

  // Reserved for future group features (permissions, sharing, etc.)
  reserved 9 to 15;
}

// Account credential record
// Field numbering strategy:
//   1-15:  Core identity fields
//   16-31: Extended metadata
//   32-47: Optional features (TOTP, custom fields)
//   48-63: Reserved for future major features
message AccountRecord {
  // === CORE IDENTITY FIELDS (1-15) ===

  // Unique identifier for the record (UUID v4 recommended)
  string id = 1;

  // Primary account name/title (e.g., "Gmail Personal")
  string account_name = 2;

  // Username or login identifier
  string user_name = 3;

  // Account password
  string password = 4;

  // Email associated with account (optional)
  string email = 5;

  // Website URL (optional)
  string website = 6;

  // Reserved for additional core identity fields
  reserved 7 to 15;

  // === EXTENDED METADATA (16-31) ===

  // Timestamp when the record was created (Unix epoch time, seconds)
  int64 created_at = 16;

  // Timestamp when the record was last modified (Unix epoch time, seconds)
  int64 modified_at = 17;

  // Timestamp when the password was last changed (Unix epoch time, seconds)
  // Used for password age tracking
  int64 password_changed_at = 18;

  // Free-form notes (max length enforced in application)
  string notes = 19;

  // Tags/categories for organizing accounts (comma-separated or repeated)
  repeated string tags = 20;

  // Favorite/starred status for quick access
  bool is_favorite = 21;

  // Whether this account is archived (hidden from main view)
  bool is_archived = 22;

  // Color code for visual organization (hex format: "#RRGGBB")
  string color = 23;

  // Icon identifier (icon name or URL)
  string icon = 24;

  // Global display order for "All Accounts" view
  // -1 = automatic sorting (favorites first, then alphabetical)
  // >= 0 = custom user-defined order
  int32 global_display_order = 25;

  // === MULTI-USER PRIVACY CONTROLS (26-28) ===

  // Admin-only viewable: Only administrators can view/edit this account
  // Standard users will not see this account in the list
  // Use case: Sensitive credentials (CEO accounts, payroll systems, etc.)
  bool is_admin_only_viewable = 26;

  // Admin-only deletable: All users can view/edit, but only admins can delete
  // Prevents accidental deletion of critical accounts
  // Use case: Protected accounts that shouldn't be accidentally deleted
  bool is_admin_only_deletable = 27;

  // Reserved for additional privacy controls
  reserved 28 to 31;

  // === OPTIONAL FEATURES (32-47) ===

  // TOTP configuration for two-factor authentication
  TOTPConfig totp = 32;

  // Custom fields for additional data
  repeated CustomField custom_fields = 33;

  // Security questions and answers
  repeated CustomField security_questions = 34;

  // Previous passwords (for history tracking)
  repeated string password_history = 35;

  // Account recovery information
  string recovery_email = 36;
  string recovery_phone = 37;

  // Group memberships (many-to-many relationship)
  // Each membership defines which group this account belongs to
  // and its display order within that group
  repeated GroupMembership groups = 38;

  // Reserved for future optional features
  reserved 39 to 47;

  // === RESERVED FOR FUTURE MAJOR FEATURES (48-63) ===
  // Reserved for attachments, shared credentials, expiration policies, etc.
  reserved 48 to 63;
}

// =============================================================================
// VAULT CONTAINER
// =============================================================================

// Vault metadata and settings
message VaultMetadata {
  // Schema version for this vault (allows for migration logic)
  // Version 1: Original schema
  // Version 2: Extended schema with TOTP, custom fields, etc.
  int32 schema_version = 1;

  // Timestamp when the vault was created (Unix epoch time, seconds)
  int64 created_at = 2;

  // Timestamp when the vault was last modified (Unix epoch time, seconds)
  int64 last_modified = 3;

  // Timestamp when the vault was last opened (Unix epoch time, seconds)
  int64 last_accessed = 4;

  // Human-readable vault name/description
  string name = 5;

  // Vault description
  string description = 6;

  // Number of times the vault has been opened
  int64 access_count = 7;

  // === VAULT-SPECIFIC SECURITY SETTINGS (8-15) ===

  // Clipboard auto-clear timeout in seconds (0 = disabled)
  // Each vault can have its own clipboard security policy
  int32 clipboard_timeout_seconds = 8;

  // Auto-lock timeout in seconds (0 = disabled)
  // Each vault can have its own auto-lock policy
  int32 auto_lock_timeout_seconds = 9;

  // Undo/redo enabled flag
  // Each vault can enable/disable undo/redo for security
  bool undo_redo_enabled = 10;

  // Undo/redo history limit (1-100 operations)
  // Maximum number of operations kept in undo history
  int32 undo_history_limit = 11;

  // Account password history enabled flag
  // Prevent reusing passwords when updating account entries
  bool account_password_history_enabled = 12;

  // Account password history limit (0-24 previous passwords)
  // Number of previous passwords to check per account
  int32 account_password_history_limit = 13;

  // Auto-lock enabled flag
  // Controls whether auto-lock is active for this vault
  // Security-critical: prevents users from disabling auto-lock via local preferences
  bool auto_lock_enabled = 14;

  // Reserved for future vault metadata
  reserved 15;
}

// Individual YubiKey entry for multiple key support
message YubiKeyEntry {
  // YubiKey serial number
  string serial = 1;

  // Optional friendly name for this key (e.g., "Primary", "Backup")
  string name = 2;

  // Timestamp when this key was added
  int64 added_at = 3;

  // Reserved for future per-key settings
  reserved 4 to 10;
}

// YubiKey configuration (if vault uses YubiKey 2FA)
message YubiKeyConfig {
  // DEPRECATED: Use yubikey_entries instead
  // Kept for backward compatibility with single-key vaults
  string serial = 1 [deprecated = true];

  // Challenge for HMAC-SHA1 (64 bytes) - shared by all configured keys
  bytes challenge = 2;

  // Timestamp when YubiKey was first configured
  int64 configured_at = 3;

  // Whether to require YubiKey for vault access
  bool required = 4;

  // List of configured YubiKeys (primary + backups)
  // All keys must be programmed with the same HMAC secret
  repeated YubiKeyEntry yubikey_entries = 5;

  // Reserved for future YubiKey features (key rotation, etc.)
  reserved 6 to 10;
}

// Container for multiple account records and vault metadata
message VaultData {
  // === CORE DATA (1-15) ===

  // List of account records stored in the vault
  repeated AccountRecord accounts = 1;

  // Vault metadata
  VaultMetadata metadata = 2;

  // Reserved for additional core vault data
  reserved 3 to 15;

  // === VAULT CONFIGURATION (16-31) ===

  // YubiKey configuration (optional, could also stay in binary header)
  YubiKeyConfig yubikey_config = 16;

  // Reed-Solomon FEC settings (could move from binary header)
  bool fec_enabled = 17;
  int32 fec_redundancy_percent = 18;

  // Backup settings
  bool backup_enabled = 19;
  int32 backup_count = 20;

  // Reserved for additional configuration
  reserved 21 to 31;

  // === ORGANIZATION FEATURES (32-47) ===

  // Account groups for organizing accounts
  // Includes both system groups (e.g., "Favorites") and user-created groups
  repeated AccountGroup groups = 32;

  // Reserved for future organizational features (templates, shared vaults, etc.)
  reserved 33 to 47;
}
