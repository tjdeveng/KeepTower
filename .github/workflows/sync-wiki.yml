# SPDX-License-Identifier: GPL-3.0-or-later
# SPDX-FileCopyrightText: 2026 tjdeveng
#
# GitHub Actions workflow to sync documentation from main repo to Wiki
#
# This workflow maintains a single source of truth for documentation:
# - Source: docs/user/ in main repository
# - Target: GitHub Wiki repository
# - Trigger: Changes to docs/user/ files
#
# Security: Uses GitHub token with wiki write permissions

name: Sync Documentation to Wiki

on:
  push:
    branches:
      - master
    paths:
      - 'docs/user/**'
      - 'docs/developer/CONTRIBUTING.md'
  workflow_dispatch:  # Allow manual triggering

jobs:
  sync-wiki:
    name: Sync Docs to Wiki
    runs-on: ubuntu-24.04

    permissions:
      contents: write  # Required for wiki access

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Checkout wiki repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync documentation files
        run: |
          # User documentation (auto-discover all numbered files)
          # Converts: XX-topic-name.md â†’ Topic-Name.md (except 00-home.md â†’ Home.md)
          for file in docs/user/[0-9][0-9]-*.md; do
            if [ -f "$file" ]; then
              basename=$(basename "$file" .md)

              # Special case: 00-home.md â†’ Home.md
              if [[ "$basename" == "00-home" ]]; then
                wikiname="Home"
              else
                # Convert: 01-getting-started â†’ Getting-Started
                wikiname=$(echo "$basename" | sed 's/^[0-9][0-9]-//' | sed -r 's/(^|-)([a-z])/\U\2/g')
              fi

              echo "Syncing: $basename.md â†’ $wikiname.md"
              cp "$file" "wiki/${wikiname}.md"
            fi
          done

          # Additional user documentation (non-numbered files)
          [ -f docs/user/README.md ] && cp docs/user/README.md wiki/README.md && echo "Synced: README.md"
          [ -f docs/user/SECURITY_BEST_PRACTICES.md ] && cp docs/user/SECURITY_BEST_PRACTICES.md wiki/Security-Best-Practices.md && echo "Synced: Security-Best-Practices.md"
          [ -f docs/user/YUBIKEY_FIPS_SETUP.md ] && cp docs/user/YUBIKEY_FIPS_SETUP.md wiki/YubiKey-FIPS-Setup.md && echo "Synced: YubiKey-FIPS-Setup.md"

          # Developer documentation
          cp docs/developer/CONTRIBUTING.md wiki/Contributing.md
          echo "Synced: Contributing.md"

          # Add sync timestamp footer to each file
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          for file in wiki/*.md; do
            if ! grep -q "Last synced:" "$file"; then
              echo "" >> "$file"
              echo "---" >> "$file"
              echo "*Last synced: $TIMESTAMP*" >> "$file"
            else
              sed -i "s/Last synced:.*/Last synced: $TIMESTAMP*/" "$file"
            fi
          done

      - name: Commit and push to wiki
        working-directory: wiki
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to wiki documentation"
            exit 0
          fi

          git add .
          git commit -m "Sync documentation from main repository

          Automated sync triggered by commit ${{ github.sha }}
          Source: docs/user/ and docs/developer/
          Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          git push origin master

      - name: Summary
        if: success()
        run: |
          echo "âœ… Wiki documentation successfully synced"
          echo "ðŸ“š Files synced from docs/user/ and docs/developer/"
          echo ""
          echo "Synced files:"
          ls -1 wiki/*.md | sed 's|wiki/||' | sed 's/^/  - /'
