name: Code Coverage

on:
  push:
    branches: [ master, main ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'meson.build'
      - 'meson_options.txt'
      - '.github/workflows/coverage.yml'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'meson.build'
      - 'meson_options.txt'
  workflow_dispatch:

jobs:
  coverage:
    name: Generate Coverage Report
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          meson \
          ninja-build \
          pkg-config \
          libgtkmm-4.0-dev \
          libprotobuf-dev \
          protobuf-compiler \
          libssl-dev \
          libgtest-dev \
          lcov \
          cmake \
          git \
          gettext \
          desktop-file-utils \
          libykpers-1-dev \
          libyubikey-dev

    - name: Cache libcorrect
      id: cache-libcorrect
      uses: actions/cache@v4
      with:
        path: /tmp/libcorrect-install
        key: libcorrect-coverage-${{ hashFiles('.github/libcorrect-version.txt') }}
        restore-keys: |
          libcorrect-coverage-
          libcorrect-ubuntu-

    - name: Build and install libcorrect
      if: steps.cache-libcorrect.outputs.cache-hit != 'true'
      run: |
        git clone https://github.com/quiet/libcorrect.git /tmp/libcorrect
        cd /tmp/libcorrect
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/tmp/libcorrect-install ..
        make -j$(nproc)
        make install

    - name: Install libcorrect to system
      run: |
        sudo cp -r /tmp/libcorrect-install/* /usr/
        sudo ldconfig

    - name: Cache OpenSSL 3.5
      id: cache-openssl
      uses: actions/cache@v4
      with:
        path: /tmp/openssl-install
        key: openssl-3.5.0-coverage-${{ hashFiles('.github/openssl-version.txt') }}
        restore-keys: |
          openssl-3.5.0-coverage-
          openssl-3.5.0-ubuntu-

    - name: Build OpenSSL 3.5 with FIPS
      if: steps.cache-openssl.outputs.cache-hit != 'true'
      run: |
        bash scripts/build-openssl-3.5.sh /tmp/openssl-build /tmp/openssl-install

    - name: Configure build with coverage
      run: |
        export PKG_CONFIG_PATH="/tmp/openssl-install/lib/pkgconfig:$PKG_CONFIG_PATH"
        export LD_LIBRARY_PATH="/tmp/openssl-install/lib64:/tmp/openssl-install/lib:$LD_LIBRARY_PATH"
        meson setup build-coverage \
          --buildtype=debug \
          -Dcoverage=true \
          -Db_coverage=true

    - name: Build
      run: |
        meson compile -C build-coverage

    - name: Run tests
      run: |
        export LD_LIBRARY_PATH="/tmp/openssl-install/lib64:/tmp/openssl-install/lib:$LD_LIBRARY_PATH"
        sudo apt-get install -y xvfb
        xvfb-run -a meson test -C build-coverage --print-errorlogs

    - name: Generate coverage report
      run: |
        bash scripts/generate-coverage.sh build-coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./build-coverage/coverage/coverage-filtered.info
        flags: unittests
        name: keeptower-coverage
        fail_ci_if_error: false
        verbose: true
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload coverage to Coveralls
      uses: coverallsapp/github-action@v2
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        file: ./build-coverage/coverage/coverage-filtered.info
        format: lcov

    - name: Generate coverage badge
      run: |
        # Extract coverage percentage
        COVERAGE=$(lcov --summary build-coverage/coverage/coverage-filtered.info 2>&1 | \
                  grep "lines" | grep -oP '\d+\.\d+(?=%)')
        echo "Coverage: $COVERAGE%"
        echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV

    - name: Upload coverage HTML report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: build-coverage/coverage/html/
        retention-days: 30

    - name: Comment PR with coverage
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const coverage = process.env.COVERAGE || 'N/A';
          const comment = `## ðŸ“Š Code Coverage Report

          **Line Coverage:** ${coverage}%

          [View Full Coverage Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
